<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="3. Advanced Concepts" href="advanced.html" /><link rel="prev" title="1. First Steps" href="first_steps.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>2. Basic Concepts - Caterpillar 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Caterpillar 1.0.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Caterpillar 1.0.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installing/index.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorial to Caterpillar</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorial to Caterpillar</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="first_steps.html">1. First Steps</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">2. Basic Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html">3. Advanced Concepts</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">Caterpillar’s Reference</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Caterpillar’s Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/introduction.html">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/datamodel.html">2. Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/operators.html">3. Operators</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../library/index.html">Library</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Library</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../library/model.html">1. Struct Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../library/options.html">2. Options</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Development</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="basic-concepts">
<span id="basics"></span><h1><span class="section-number">2. </span>Basic Concepts<a class="headerlink" href="#basic-concepts" title="Link to this heading">#</a></h1>
<p>In this section, we’ll explore some common techniques used in binary file formats, setting
the stage for more advanced topics in the next chapter.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Some examples using the interpreter prompts make use of a shortcut to define <code class="xref py py-class docutils literal notranslate"><span class="pre">Field</span></code>
objects:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">caterpillar.shortcuts</span> <span class="kn">import</span> <span class="n">F</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="standard-types">
<h2><span class="section-number">2.1. </span>Standard Types<a class="headerlink" href="#standard-types" title="Link to this heading">#</a></h2>
<section id="numbers">
<h3><span class="section-number">2.1.1. </span>Numbers<a class="headerlink" href="#numbers" title="Link to this heading">#</a></h3>
<p>When dealing with binary data, numbers play a crucial role. Besides the default integer types
(e.g., uint8, uint16, etc.), <em>caterpillar</em> introduces some special integer formats. The default
types include:</p>
<ul class="simple">
<li><p>Unsigned (<code class="code docutils literal notranslate"><span class="pre">u...</span></code>) and signed: <code class="xref py py-attr docutils literal notranslate"><span class="pre">int8</span></code>, <code class="xref py py-attr docutils literal notranslate"><span class="pre">int16</span></code>, <code class="xref py py-attr docutils literal notranslate"><span class="pre">int32</span></code> and <code class="xref py py-attr docutils literal notranslate"><span class="pre">int64</span></code></p></li>
<li><p>Floating point: <code class="xref py py-attr docutils literal notranslate"><span class="pre">float32</span></code> and <code class="xref py py-attr docutils literal notranslate"><span class="pre">float64</span></code> aka <code class="xref py py-attr docutils literal notranslate"><span class="pre">double</span></code></p></li>
</ul>
<section id="custom-sized-integer">
<h4><span class="section-number">2.1.1.1. </span>Custom-sized integer<a class="headerlink" href="#custom-sized-integer" title="Link to this heading">#</a></h4>
<p>It’s also possible to use integers with a custom size (in bits). However, it’s important to note
that you have to define the struct with the bit count, and internally, only the occupied bytes
will be used. For example:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">Int</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>      <span class="c1"># three-byte signed integer</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">UInt</span><span class="p">(</span><span class="mi">40</span><span class="p">))</span>     <span class="c1"># five-byte unsigned integer</span>
</pre></div>
</div>
</section>
<section id="variable-sized-integer">
<h4><span class="section-number">2.1.1.2. </span>Variable-sized integer<a class="headerlink" href="#variable-sized-integer" title="Link to this heading">#</a></h4>
<p>The built-in struct <code class="xref py py-class docutils literal notranslate"><span class="pre">VarInt</span></code> supports parsing and building integers with variable length. Its
documentation provides a detailed explanation of all different configurations.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">VarInt</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="enumerations">
<h3><span class="section-number">2.1.2. </span>Enumerations<a class="headerlink" href="#enumerations" title="Link to this heading">#</a></h3>
<p>Enums are essential when working with binary file formats, and <em>caterpillar</em> integrates
standard Python enumerations - classes extending  <code class="code docutils literal notranslate"><span class="pre">enum.Enum</span></code> - with ease.</p>
<p>Let’s revisit <a class="reference external" href="https://www.w3.org/TR/png/#11pHYs">pHYS</a> chunk to add an enum to the
last field.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Simple enumeration in a struct definition</span><a class="headerlink" href="#id1" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">enum</span>

<span class="k">class</span> <span class="nc">PHYSUnit</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span> <span class="c1"># &lt;-- the enum value doesn&#39;t have to be int</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">METRE</span> <span class="o">=</span> <span class="mi">1</span>

<span class="nd">@struct</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">BigEndian</span><span class="p">)</span>         <span class="c1"># &lt;-- same as before</span>
<span class="k">class</span> <span class="nc">PHYSChunk</span><span class="p">:</span>
    <span class="n">pixels_per_unit_x</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="n">pixels_per_unit_y</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="n">unit</span><span class="p">:</span> <span class="n">Enum</span><span class="p">(</span><span class="n">PHYSUnit</span><span class="p">,</span> <span class="n">uint8</span><span class="p">)</span>  <span class="c1"># &lt;-- now we have an auto-enumeration</span>
</pre></div>
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>It’s worth noting that a default value can be specified for the field as a fallback. If
none is provided, and an unpacked value not in the enumeration is encountered, an error
will be triggered.</p>
</div>
</section>
<section id="arrays-lists">
<h3><span class="section-number">2.1.3. </span>Arrays/Lists<a class="headerlink" href="#arrays-lists" title="Link to this heading">#</a></h3>
<p>Binary formats often require storing multiple objects of the same type sequentially. <em>Caterpillar</em>
simplifies this with item access for defining arrays of static or dynamic size.</p>
<p>We started with the <a class="reference external" href="https://www.w3.org/TR/png/#11PLTE">PLTE</a> chunk, which stores three-byte
sequences. We can define an array of RGB objects as follows:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">PLTEChunk</span> <span class="o">=</span> <span class="n">RGB</span><span class="p">[</span><span class="n">this</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<p>Since this chunk has only one field, the array specifier is used to make it a list type. The
length is calculated based on the chunk’s length field divided by three because the RGB class
occupies three bytes.</p>
</section>
<section id="string-types">
<h3><span class="section-number">2.1.4. </span>String Types<a class="headerlink" href="#string-types" title="Link to this heading">#</a></h3>
<section id="cstring">
<h4><span class="section-number">2.1.4.1. </span>CString<a class="headerlink" href="#cstring" title="Link to this heading">#</a></h4>
<p>The CString in this library extends beyond a mere reference to C strings. It provides
additional functionality, as demonstrated in the structure of the next chunk.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">The <a class="reference external" href="https://www.w3.org/TR/png/#11tEXt">tEXt</a> chunk structure</span><a class="headerlink" href="#id2" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span>
<span class="k">class</span> <span class="nc">TEXTChunk</span><span class="p">:</span>
    <span class="c1"># dynamic sized string that ends with a null-byte</span>
    <span class="n">keyword</span><span class="p">:</span> <span class="n">CString</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span>
    <span class="c1"># static sized string based on the current context. some notes:</span>
    <span class="c1">#   - parent.length is the current chunkt&#39;s length</span>
    <span class="c1">#   - lenof(...) is the runtime length of the context variable</span>
    <span class="c1">#   - 1 because of the extra null-byte that is stripped from keyword</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">CString</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">parent</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">lenof</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">keword</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition-challenge admonition">
<p class="admonition-title">Challenge</p>
<p>You are now ready to implement the <a class="reference external" href="https://www.w3.org/TR/png/#11iTXt">iTXt</a> chunk. Try it yourself!</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-icon"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-check" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></span>Solution<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">This solution serves as an example and isn’t the only way to approach it!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span>
<span class="k">class</span> <span class="nc">ITXTChunk</span><span class="p">:</span>
    <span class="n">keyword</span><span class="p">:</span> <span class="n">CString</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">compression_flag</span><span class="p">:</span> <span class="n">uint8</span>
    <span class="c1"># we actually don&#39;t need an Enum here</span>
    <span class="n">compression_method</span><span class="p">:</span> <span class="n">uint8</span>
    <span class="n">language_tag</span><span class="p">:</span> <span class="n">CString</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ASCII&quot;</span><span class="p">)</span>
    <span class="n">translated_keyword</span><span class="p">:</span> <span class="n">CString</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="c1"># length is calculated with parent.length - len(keyword)+len(b&quot;\x00&quot;) - ...</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">CString</span><span class="p">(</span>
        <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">length</span><span class="o">=</span><span class="n">parent</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">lenof</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">translated_keyword</span><span class="p">)</span> <span class="o">-</span> <span class="n">lenof</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">keyword</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</details></div>
<p>You can also apply your own termination character, for example:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">struct</span> <span class="o">=</span> <span class="n">CString</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\x0A</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This struct will use a space as the termination character and strip all trailing
padding bytes.</p>
</section>
<section id="string">
<h4><span class="section-number">2.1.4.2. </span>String<a class="headerlink" href="#string" title="Link to this heading">#</a></h4>
<p>Besides special the special <em>c strings</em> there’s a default <code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code> class that implements
the basic behaviour of a string. It’s crucial to specify the length for this struct.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">struct</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="mi">100</span> <span class="ow">or</span> <span class="n">this</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="c1"># static integer or context lambda</span>
</pre></div>
</div>
</section>
<section id="prefixed">
<h4><span class="section-number">2.1.4.3. </span>Prefixed<a class="headerlink" href="#prefixed" title="Link to this heading">#</a></h4>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">Prefixed</span></code> class introduces so-called <em>Pascal strings</em> for raw bytes and strings. If no
encoding is specified, the returned value will be of type <code class="code docutils literal notranslate"><span class="pre">bytes</span></code>. This class reads a length
using the given struct and then retrieves the corresponding number of bytes from the stream returned
by that struct.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">Prefixed</span><span class="p">(</span><span class="n">uint8</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
<span class="go">b&#39;\rHello, World!&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">unpack</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
<span class="go">&#39;Hello, World!&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="byte-sequences">
<h3><span class="section-number">2.1.5. </span>Byte Sequences<a class="headerlink" href="#byte-sequences" title="Link to this heading">#</a></h3>
<section id="memory">
<h4><span class="section-number">2.1.5.1. </span>Memory<a class="headerlink" href="#memory" title="Link to this heading">#</a></h4>
<p>When dealing with data that can be stored in memory and you intend to print out your
unpacked object, the <code class="xref py py-class docutils literal notranslate"><span class="pre">Memory</span></code> struct is recommended.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">Memory</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="c1"># static size; dynamic size is allowed too</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pack</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)],</span> <span class="n">m</span><span class="p">))</span>
<span class="go">b&#39;\x00\x01\x02\x03\x04&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">unpack</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
<span class="go">&lt;memory at 0x00000204FDFA4411&gt;</span>
</pre></div>
</div>
</section>
<section id="bytes">
<h4><span class="section-number">2.1.5.2. </span>Bytes<a class="headerlink" href="#bytes" title="Link to this heading">#</a></h4>
<p>If direct access to the bytes is what you need, the <code class="xref py py-class docutils literal notranslate"><span class="pre">Bytes</span></code> struct comes in handy. It
converts the <code class="code docutils literal notranslate"><span class="pre">memoryview</span></code> to <code class="code docutils literal notranslate"><span class="pre">bytes</span></code>. Additionally, as mentioned earlier, you can
use the <code class="xref py py-class docutils literal notranslate"><span class="pre">Prefixed</span></code> class to unpack bytes of a prefixed size.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">Bytes</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="c1"># static, dynamic and greedy size allowed</span>
</pre></div>
</div>
<p>With the gained knowledge, let’s implement the struct for the <a class="reference external" href="https://www.w3.org/TR/png/#fdAT-chunk">fDAT</a>
chunk of our PNG format. It should look like this:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Implementation for the frame data chunk</span><a class="headerlink" href="#id3" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">BigEndian</span><span class="p">)</span>                    <span class="c1"># &lt;-- endianess as usual</span>
<span class="k">class</span> <span class="nc">FDATChunk</span><span class="p">:</span>
    <span class="n">sequence_number</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="c1"># We rather use a memory instance here instead of Bytes()</span>
    <span class="n">frame_data</span><span class="p">:</span> <span class="n">Memory</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition-challenge admonition">
<p class="admonition-title">Challenge</p>
<p>If you feel ready for a more advanced structure, try implementing the
<a class="reference external" href="https://www.w3.org/TR/png/#11zTXt">zTXt</a> chunk for compressed textual data.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Solution<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Sample implementation of the <em>zTXt</em> chunk</span><a class="headerlink" href="#id4" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span>                             <span class="c1"># &lt;-- actually, we don&#39;t need a specific byteorder</span>
<span class="k">class</span> <span class="nc">ZTXTChunk</span><span class="p">:</span>
    <span class="n">keyword</span><span class="p">:</span> <span class="n">CString</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>           <span class="c1"># &lt;-- variable length</span>
    <span class="n">compression_method</span><span class="p">:</span> <span class="n">uint8</span>
    <span class="c1"># Okay, we haven&#39;t introduced this struct yet, but Memory() or Bytes()</span>
    <span class="c1"># would heve been okay, too.</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">ZLibCompressed</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">lenof</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">keyword</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</details></div>
</section>
</section>
<section id="padding">
<h3><span class="section-number">2.1.6. </span>Padding<a class="headerlink" href="#padding" title="Link to this heading">#</a></h3>
<p>In certain scenarios, you may need to apply padding to your structs. <em>caterpillar</em> doesn’t
store any data associated with paddings. If you need to retain the content of a padding,
you can use <code class="xref py py-class docutils literal notranslate"><span class="pre">Bytes</span></code> or <code class="xref py py-class docutils literal notranslate"><span class="pre">Memory</span></code> again. For example:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">padding</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>  <span class="c1"># padding always with a length</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>That was a lot of input to take, time for a coffee break! ☕</p>
</div>
</section>
</section>
<section id="standard-structs">
<h2><span class="section-number">2.2. </span>Standard Structs<a class="headerlink" href="#standard-structs" title="Link to this heading">#</a></h2>
<p>We still have some important struct types to discuss to start defining <em>complex</em> structs.</p>
<section id="constants">
<h3><span class="section-number">2.2.1. </span>Constants<a class="headerlink" href="#constants" title="Link to this heading">#</a></h3>
<p>Proprietary file formats or binary formats often store <a class="reference external" href="https://www.garykessler.net/library/file_sigs.html">magic bytes</a>
usually at the start of the data stream. Constant values will be validated against the parsed
data and will be applied to the class automatically, eliminating the need to write them into
the constructor every time.</p>
<p>Currently, there are three different types of constant structs:</p>
<section id="constbytes">
<h4><span class="section-number">2.2.1.1. </span>ConstBytes<a class="headerlink" href="#constbytes" title="Link to this heading">#</a></h4>
<p>These constants can be defined implicitly by annotating a field in a struct class with bytes.
For example, in the case of starting the <em>main</em> PNG struct:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Starting the <em>main</em> PNG struct</span><a class="headerlink" href="#id5" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">BigEndian</span><span class="p">)</span> <span class="c1"># &lt;-- will be relevant later on</span>
<span class="k">class</span> <span class="nc">PNG</span><span class="p">:</span>
    <span class="n">magic</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x89</span><span class="s2">PNG</span><span class="se">\x0D\x0A\x1A\x0A</span><span class="s2">&quot;</span>
    <span class="c1"># other fields will be defined at the end of this tutorial.</span>
</pre></div>
</div>
</div>
</section>
<section id="conststring">
<h4><span class="section-number">2.2.1.2. </span>ConstString<a class="headerlink" href="#conststring" title="Link to this heading">#</a></h4>
<p>This struct type is essentially the same as <code class="xref py py-class docutils literal notranslate"><span class="pre">ConstBytes</span></code> but uses a string value
for validation.</p>
</section>
<section id="const">
<h4><span class="section-number">2.2.1.3. </span>Const<a class="headerlink" href="#const" title="Link to this heading">#</a></h4>
<p>Raw constant values require a struct to be defined to parse or build the value.
For example:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">Const</span><span class="p">(</span><span class="mh">0xbeef</span><span class="p">,</span> <span class="n">uint32</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="compression">
<h3><span class="section-number">2.2.2. </span>Compression<a class="headerlink" href="#compression" title="Link to this heading">#</a></h3>
<p>This library also supports default compression formats like <em>zlib</em>, <em>lzma</em>, <em>bz2</em> and, if
installed via pip, <em>lzo</em> (using <code class="code docutils literal notranslate"><span class="pre">lzallright</span></code>).</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">field</span> <span class="o">=</span> <span class="n">ZLibCompressed</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># length or struct here applicable</span>
</pre></div>
</div>
</section>
<section id="specials">
<h3><span class="section-number">2.2.3. </span>Specials<a class="headerlink" href="#specials" title="Link to this heading">#</a></h3>
<section id="computed">
<h4><span class="section-number">2.2.3.1. </span>Computed<a class="headerlink" href="#computed" title="Link to this heading">#</a></h4>
<p>A runtime computed variable that does not pack any data.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">struct</span> <span class="o">=</span> <span class="n">Computed</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">foobar</span><span class="p">)</span> <span class="c1"># context lambda or constant value</span>
</pre></div>
</div>
<div class="admonition-challenge admonition">
<p class="admonition-title">Challenge</p>
<p>Implement the <a class="reference external" href="https://www.w3.org/TR/png/#11gAMA">gAMA</a> chunk for our PNG format and use
a <code class="xref py py-class docutils literal notranslate"><span class="pre">Computed</span></code> struct to calculate the real gamma value.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Solution<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">Example implementation of the <em>gAMA</em> chunk</span><a class="headerlink" href="#id6" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">BigEndian</span><span class="p">)</span>    <span class="c1"># &lt;-- same as usual</span>
<span class="k">class</span> <span class="nc">GAMAChunk</span><span class="p">:</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="n">gamma_value</span><span class="p">:</span> <span class="n">Computed</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">gamma</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p class="sd-card-text">Question: Do we really need to introduce the gamma_value using a <code class="xref py py-class docutils literal notranslate"><span class="pre">Computed</span></code> struct here
or can we just define a method?</p>
</div>
</div>
</details></div>
</section>
<section id="pass">
<h4><span class="section-number">2.2.3.2. </span>Pass<a class="headerlink" href="#pass" title="Link to this heading">#</a></h4>
<p>In case nothing should be done, just use <code class="xref py py-class docutils literal notranslate"><span class="pre">Pass</span></code>.</p>
<hr><div class="admonition important">
<p class="admonition-title">Important</p>
<p>Congratulations! You have successfully mastered the basics of <em>caterpillar</em>! Are you
ready for the next level? Brace yourself for some breathtaking action!</p>
</div>
</section>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="advanced.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title"><span class="section-number">3. </span>Advanced Concepts</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="first_steps.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title"><span class="section-number">1. </span>First Steps</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, MatrixEditor
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">2. Basic Concepts</a><ul>
<li><a class="reference internal" href="#standard-types">2.1. Standard Types</a><ul>
<li><a class="reference internal" href="#numbers">2.1.1. Numbers</a><ul>
<li><a class="reference internal" href="#custom-sized-integer">2.1.1.1. Custom-sized integer</a></li>
<li><a class="reference internal" href="#variable-sized-integer">2.1.1.2. Variable-sized integer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#enumerations">2.1.2. Enumerations</a></li>
<li><a class="reference internal" href="#arrays-lists">2.1.3. Arrays/Lists</a></li>
<li><a class="reference internal" href="#string-types">2.1.4. String Types</a><ul>
<li><a class="reference internal" href="#cstring">2.1.4.1. CString</a></li>
<li><a class="reference internal" href="#string">2.1.4.2. String</a></li>
<li><a class="reference internal" href="#prefixed">2.1.4.3. Prefixed</a></li>
</ul>
</li>
<li><a class="reference internal" href="#byte-sequences">2.1.5. Byte Sequences</a><ul>
<li><a class="reference internal" href="#memory">2.1.5.1. Memory</a></li>
<li><a class="reference internal" href="#bytes">2.1.5.2. Bytes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#padding">2.1.6. Padding</a></li>
</ul>
</li>
<li><a class="reference internal" href="#standard-structs">2.2. Standard Structs</a><ul>
<li><a class="reference internal" href="#constants">2.2.1. Constants</a><ul>
<li><a class="reference internal" href="#constbytes">2.2.1.1. ConstBytes</a></li>
<li><a class="reference internal" href="#conststring">2.2.1.2. ConstString</a></li>
<li><a class="reference internal" href="#const">2.2.1.3. Const</a></li>
</ul>
</li>
<li><a class="reference internal" href="#compression">2.2.2. Compression</a></li>
<li><a class="reference internal" href="#specials">2.2.3. Specials</a><ul>
<li><a class="reference internal" href="#computed">2.2.3.1. Computed</a></li>
<li><a class="reference internal" href="#pass">2.2.3.2. Pass</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=8d563738"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    </body>
</html>